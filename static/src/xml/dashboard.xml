<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="dashboard_projet.Dashboard">
        <!-- Container principal avec design sobre -->
        <div class="dashboard-container-modern">
            
            <!-- Header fixe avec filtres -->
            <div class="dashboard-header-fixed">
                <div class="container-fluid">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="dashboard-controls-grid">
                                <div class="control-group">
                                    <label class="control-label">Date de début</label>
                                    <input type="date" 
                                           t-model="state.dateDebut" 
                                           t-on-change="onDateChange"
                                           class="form-control-modern"/>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">Date de fin</label>
                                    <input type="date" 
                                           t-model="state.dateFin" 
                                           t-on-change="onDateChange"
                                           class="form-control-modern"/>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">Actions</label>
                                    <div class="btn-group-modern">
                                        <button class="btn-modern btn-export" 
                                                t-on-click="() => exportDashboard('csv')"
                                                t-att-disabled="state.loadingStates.export"
                                                title="Export CSV">
                                            <i class="fa fa-file-text"/> CSV
                                        </button>
                                        <button class="btn-modern btn-export" 
                                                t-on-click="() => exportDashboard('excel')"
                                                t-att-disabled="state.loadingStates.export"
                                                title="Export Excel">
                                            <i class="fa fa-file-excel"/> Excel
                                        </button>
                                        <button class="btn-modern btn-export" 
                                                t-on-click="() => exportDashboard('pdf')"
                                                t-att-disabled="state.loadingStates.export"
                                                title="Export PDF">
                                            <i class="fa fa-file-pdf"/> PDF
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="system-status-modern">
                                <div t-att-class="'status-indicator ' + getHealthStatusClass()">
                                    <i t-att-class="'fa ' + getHealthStatusIcon()"/>
                                    <span class="status-text">
                                        <t t-if="state.systemStatus.healthy">Système opérationnel</t>
                                        <t t-elif="state.systemStatus.warnings.length">Système dégradé</t>
                                        <t t-else="">Système indisponible</t>
                                    </span>
                                </div>
                                <t t-if="state.systemStatus.lastCheck">
                                    <div class="status-time">
                                        Dernière vérif: <t t-esc="new Date(state.systemStatus.lastCheck).toLocaleTimeString('fr-FR')"/>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertes système -->
            <t t-if="state.systemStatus.errors.length or state.systemStatus.warnings.length">
                <div class="dashboard-alerts-modern">
                    <t t-foreach="state.systemStatus.errors" t-as="error" t-key="error_index">
                        <div class="alert-modern alert-error">
                            <i class="fa fa-exclamation-triangle"/>
                            <span t-esc="error"/>
                        </div>
                    </t>
                    <t t-foreach="state.systemStatus.warnings" t-as="warning" t-key="warning_index">
                        <div class="alert-modern alert-warning">
                            <i class="fa fa-exclamation-circle"/>
                            <span t-esc="warning"/>
                        </div>
                    </t>
                </div>
            </t>

            <!-- Loading overlay global -->
            <t t-if="state.loading">
                <div class="loading-overlay-modern">
                    <div class="loading-spinner">
                        <div class="spinner-modern"></div>
                        <div class="loading-text">Chargement des données...</div>
                        <div class="loading-progress">
                            <div class="progress-bar-modern"></div>
                        </div>
                    </div>
                </div>
            </t>

            <!-- Contenu scrollable -->
            <div class="dashboard-content-scrollable" 
                 t-ref="scrollContainer"
                 t-att-class="state.loading ? 'loading' : ''">
                
                <!-- Métriques principales avec design sobre -->
                <section class="metrics-section">
                    <div class="section-header">
                        <h2 class="section-title">Vue d'ensemble</h2>
                        <div class="section-subtitle">Indicateurs clés de performance</div>
                    </div>
                    
                    <div class="metrics-grid">
                        <!-- Chiffre d'affaires -->
                        <div class="metric-card-modern metric-ca">
                            <div class="metric-content">
                                <div class="metric-icon-modern">
                                    <i class="fa fa-euro-sign"/>
                                </div>
                                <div class="metric-info">
                                    <div class="metric-label">Chiffre d'Affaires</div>
                                    <div class="metric-value-modern">
                                        <t t-esc="formatCurrency(state.dashboardData.chiffre_affaires)"/>
                                    </div>
                                    <div class="metric-subtitle">
                                        Période: <t t-esc="state.dateDebut"/> au <t t-esc="state.dateFin"/>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Projets actifs -->
                        <div class="metric-card-modern metric-projects">
                            <div class="metric-content">
                                <div class="metric-icon-modern">
                                    <i class="fa fa-project-diagram"/>
                                </div>
                                <div class="metric-info">
                                    <div class="metric-label">Projets Actifs</div>
                                    <div class="metric-value-modern">
                                        <t t-esc="state.dashboardData.projets?.length || 0"/>
                                    </div>
                                    <div class="metric-subtitle">
                                        <t t-esc="formatNumber(getTotalHeures(), 0)"/>h travaillées
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Personnel -->
                        <div class="metric-card-modern metric-personnel">
                            <div class="metric-content">
                                <div class="metric-icon-modern">
                                    <i class="fa fa-users"/>
                                </div>
                                <div class="metric-info">
                                    <div class="metric-label">Personnel Affecté</div>
                                    <div class="metric-value-modern">
                                        <t t-esc="getTotalPersonnel()"/>
                                    </div>
                                    <div class="metric-subtitle">
                                        Personnes sur projets
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Budget -->
                        <div class="metric-card-modern metric-budget">
                            <div class="metric-content">
                                <div class="metric-icon-modern">
                                    <i class="fa fa-chart-pie"/>
                                </div>
                                <div class="metric-info">
                                    <div class="metric-label">Budget Total</div>
                                    <div class="metric-value-modern">
                                        <t t-esc="formatCurrency(getTotalBudget())"/>
                                    </div>
                                    <div class="metric-subtitle">
                                        <t t-set="ecart" t-value="getBudgetEcart()"/>
                                        <span t-att-class="getBudgetClass(ecart)">
                                            <t t-if="ecart >= 0">+</t><t t-esc="formatPercentage(ecart)"/> écart
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section graphiques -->
                <section class="charts-section">
                    <div class="section-header">
                        <h2 class="section-title">Analyses graphiques</h2>
                        <div class="section-subtitle">Visualisation des tendances</div>
                    </div>
                    
                    <div class="charts-grid">
                        <!-- Graphique évolution CA -->
                        <div class="chart-card-modern">
                            <div class="chart-header">
                                <h3 class="chart-title">Évolution du CA</h3>
                                <div class="chart-loading" t-if="state.loadingStates.charts">
                                    <i class="fa fa-spinner fa-spin"/> Chargement...
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="caEvolutionChart" width="400" height="200"/>
                            </div>
                        </div>

                        <!-- Graphique répartition projets -->
                        <div class="chart-card-modern">
                            <div class="chart-header">
                                <h3 class="chart-title">Projets par statut</h3>
                            </div>
                            <div class="chart-content">
                                <canvas id="projectsStageChart" width="400" height="200"/>
                            </div>
                        </div>

                        <!-- Graphique marges -->
                        <div class="chart-card-modern chart-full-width">
                            <div class="chart-header">
                                <h3 class="chart-title">Marges par projet</h3>
                            </div>
                            <div class="chart-content">
                                <canvas id="margeChart" width="800" height="300"/>
                            </div>
                        </div>

                        <!-- Graphique budget vs réalisé -->
                        <div class="chart-card-modern chart-full-width">
                            <div class="chart-header">
                                <h3 class="chart-title">Budget vs Réalisé</h3>
                            </div>
                            <div class="chart-content">
                                <canvas id="budgetChart" width="800" height="300"/>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Résumé financier détaillé -->
                <section class="summary-section">
                    <div class="section-header">
                        <h2 class="section-title">Résumé financier</h2>
                        <div class="section-subtitle">Détail des marges et coûts</div>
                    </div>
                    
                    <div class="summary-grid">
                        <div class="summary-card-modern">
                            <div class="summary-item">
                                <div class="summary-label">CA Total</div>
                                <div class="summary-value text-success">
                                    <t t-esc="formatCurrency(state.dashboardData.marge_administrative?.ca_total || 0)"/>
                                </div>
                            </div>
                        </div>
                        <div class="summary-card-modern">
                            <div class="summary-item">
                                <div class="summary-label">Coûts Admin</div>
                                <div class="summary-value text-warning">
                                    <t t-esc="formatCurrency(state.dashboardData.marge_administrative?.cout_admin || 0)"/>
                                </div>
                            </div>
                        </div>
                        <div class="summary-card-modern">
                            <div class="summary-item">
                                <div class="summary-label">Marge Nette</div>
                                <div class="summary-value text-primary">
                                    <t t-esc="formatCurrency(state.dashboardData.marge_administrative?.marge_admin || 0)"/>
                                </div>
                            </div>
                        </div>
                        <div class="summary-card-modern">
                            <div class="summary-item">
                                <div class="summary-label">Taux de Marge</div>
                                <div class="summary-value">
                                    <t t-set="taux" t-value="state.dashboardData.marge_administrative?.taux_marge_admin || 0"/>
                                    <span t-att-class="getMargeClass(taux)">
                                        <t t-esc="formatPercentage(taux)"/>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Tableau des projets moderne -->
                <section class="projects-section">
                    <div class="section-header">
                        <h2 class="section-title">Détail des projets</h2>
                        <div class="section-subtitle">
                            <span class="project-count">
                                <t t-esc="state.dashboardData.projets?.length || 0"/> projet(s)
                            </span>
                            <t t-if="state.loadingStates.margins">
                                <span class="loading-indicator">
                                    <i class="fa fa-spinner fa-spin"/> Chargement marges...
                                </span>
                            </t>
                        </div>
                    </div>
                    
                    <div class="table-container-modern">
                        <t t-if="!state.dashboardData.projets?.length and !state.loading">
                            <div class="empty-state-modern">
                                <div class="empty-icon">
                                    <i class="fa fa-inbox"/>
                                </div>
                                <div class="empty-title">Aucun projet trouvé</div>
                                <div class="empty-subtitle">
                                    Aucun projet n'a été trouvé pour la période sélectionnée.
                                </div>
                                <button class="btn-modern btn-primary" t-on-click="refreshDashboard">
                                    <i class="fa fa-refresh"/> Actualiser
                                </button>
                            </div>
                        </t>
                        
                        <t t-else="">
                            <div class="table-scroll">
                                <table class="table-modern">
                                    <thead>
                                        <tr>
                                            <th class="col-project">
                                                <i class="fa fa-project-diagram"/> Projet
                                            </th>
                                            <th class="col-numeric">
                                                <i class="fa fa-euro-sign"/> CA
                                            </th>
                                            <th class="col-center">
                                                <i class="fa fa-users"/> Personnel
                                            </th>
                                            <th class="col-numeric">
                                                <i class="fa fa-clock"/> Heures
                                            </th>
                                            <th class="col-numeric">
                                                <i class="fa fa-chart-pie"/> Budget
                                            </th>
                                            <th class="col-center">
                                                <i class="fa fa-percentage"/> Marge
                                            </th>
                                            <th class="col-center">
                                                <i class="fa fa-flag"/> Statut
                                            </th>
                                            <th class="col-actions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="state.dashboardData.projets || []" t-as="projet" t-key="projet.id">
                                            <tr class="project-row-modern" t-att-data-project-id="projet.id">
                                                <!-- Nom du projet -->
                                                <td class="project-name-cell">
                                                    <div class="project-info-modern">
                                                        <div class="project-title-modern" t-att-title="projet.name">
                                                            <t t-esc="projet.name"/>
                                                        </div>
                                                        <div class="project-id-modern">
                                                            #<t t-esc="projet.id"/>
                                                        </div>
                                                    </div>
                                                </td>
                                                
                                                <!-- CA -->
                                                <td class="numeric-cell">
                                                    <div class="amount-display">
                                                        <t t-esc="formatCurrency(projet.ca)"/>
                                                    </div>
                                                </td>
                                                
                                                <!-- Personnel -->
                                                <td class="center-cell">
                                                    <div class="badge-modern badge-info">
                                                        <i class="fa fa-user"/>
                                                        <t t-esc="projet.nb_personnes"/>
                                                    </div>
                                                </td>
                                                
                                                <!-- Heures -->
                                                <td class="numeric-cell">
                                                    <div class="hours-display">
                                                        <t t-esc="formatNumber(projet.heures, 1)"/>h
                                                    </div>
                                                </td>
                                                
                                                <!-- Budget -->
                                                <td class="numeric-cell">
                                                    <div class="budget-info">
                                                        <div class="budget-value">
                                                            <t t-esc="formatCurrency(projet.budget_prevu || 0)"/>
                                                        </div>
                                                        <t t-if="projet.budget_prevu">
                                                            <div class="budget-usage">
                                                                <t t-set="usage" t-value="((projet.budget_consomme || 0) / projet.budget_prevu) * 100"/>
                                                                <div class="progress-mini">
                                                                    <div class="progress-bar-mini" 
                                                                         t-att-style="'width: ' + Math.min(usage, 100) + '%'"
                                                                         t-att-class="usage > 100 ? 'over-budget' : (usage > 80 ? 'warning-budget' : 'normal-budget')"/>
                                                                </div>
                                                                <small><t t-esc="formatPercentage(usage)"/> utilisé</small>
                                                            </div>
                                                        </t>
                                                    </div>
                                                </td>
                                                
                                                <!-- Marge -->
                                                <td class="center-cell">
                                                    <t t-set="marge" t-value="getMargeProjet(projet)"/>
                                                    <t t-if="projet.marge_data">
                                                        <div class="marge-display" 
                                                             t-att-class="getMargeClass(marge)"
                                                             t-att-title="'Revenus: ' + formatCurrency(projet.marge_data.revenus) + ' - Coûts: ' + formatCurrency(projet.marge_data.cout_salarial)">
                                                            <div class="marge-percentage">
                                                                <t t-esc="formatPercentage(marge)"/>
                                                            </div>
                                                            <div class="marge-amount">
                                                                <t t-esc="formatCurrency(projet.marge_data.marge)"/>
                                                            </div>
                                                        </div>
                                                    </t>
                                                    <t t-else="">
                                                        <div class="marge-loading">
                                                            <i class="fa fa-spinner fa-spin"/>
                                                            <small>Calcul...</small>
                                                        </div>
                                                    </t>
                                                </td>
                                                
                                                <!-- Statut -->
                                                <td class="center-cell">
                                                    <div class="status-badge-modern">
                                                        <t t-esc="projet.stage"/>
                                                    </div>
                                                </td>
                                                
                                                <!-- Actions -->
                                                <td class="actions-cell">
                                                    <button class="btn-action-modern" 
                                                            t-on-click="() => openProjectDetail(projet.id)"
                                                            title="Voir le détail du projet">
                                                        <i class="fa fa-eye"/>
                                                    </button>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                    
                                    <!-- Footer avec totaux -->
                                    <tfoot>
                                        <tr class="totals-row">
                                            <td class="totals-label">
                                                <strong>TOTAUX</strong>
                                            </td>
                                            <td class="numeric-cell">
                                                <strong class="text-success">
                                                    <t t-esc="formatCurrency(state.dashboardData.projets?.reduce((sum, p) => sum + (p.ca || 0), 0) || 0)"/>
                                                </strong>
                                            </td>
                                            <td class="center-cell">
                                                <strong class="text-info">
                                                    <t t-esc="getTotalPersonnel()"/>
                                                </strong>
                                            </td>
                                            <td class="numeric-cell">
                                                <strong class="text-primary">
                                                    <t t-esc="formatNumber(getTotalHeures(), 0)"/>h
                                                </strong>
                                            </td>
                                            <td class="numeric-cell">
                                                <strong class="text-warning">
                                                    <t t-esc="formatCurrency(getTotalBudget())"/>
                                                </strong>
                                            </td>
                                            <td colspan="3" class="center-cell">
                                                <small class="text-muted">
                                                    <t t-esc="state.dashboardData.projets?.length || 0"/> projet(s)
                                                </small>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </t>
                    </div>
                </section>
            </div>

            <!-- Scroll to top button -->
            <t t-if="showScrollToTop()">
                <button class="scroll-to-top-btn" t-on-click="scrollToTop" title="Retour en haut">
                    <i class="fa fa-chevron-up"/>
                </button>
            </t>

            <!-- Footer -->
            <div class="dashboard-footer-modern">
                <div class="container-fluid">
                    <div class="footer-content">
                        <div class="footer-left">
                            <div class="footer-info">
                                <i class="fa fa-info-circle"/>
                                Dernière mise à jour: <t t-esc="new Date().toLocaleString('fr-FR')"/>
                            </div>
                        </div>
                        <div class="footer-right">
                            <div class="footer-version">
                                Dashboard Projets v2.0 - Odoo 17 - <t t-esc="new Date().getFullYear()"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>
</templates>